#
# LoPresti smart home - automation configuration for Home Assistant
#
# Cucù
# credits to CCOSTAN@github
####################################################################

alias: 'Orologio a cucù'
trigger:
  - platform: time
    minutes: 59
    seconds: 50
  - platform: time
    minutes: 29
    seconds: 50

condition:
  - condition: time
    after: '07:50:00'
    before: '22:10:00'
  - condition: state
    entity_id: group.famiglia
    state: 'home'
  - condition: template      # check the amplifier, the TV decoder, and the BD/DVD
    value_template: >
      {% if is_state('media_player.amplificatore_onkyo', 'on') or is_state('sensor.dtsunrisetv', 'on') or is_state('sensor.dtbddvd', 'on') %}
        false
      {% else %}
        true
      {% endif %}
  - condition: template      # anything but 'Notte' is OK
    value_template: "{{ states.input_select.statocasa.state != 'Notte' }}"

action:
  - service: media_player.turn_on
    entity_id: media_player.chromecast

  - service: media_player.volume_set
    entity_id: media_player.chromecast
    data:
      volume_level: 0.75       # 75% of the main amplifier volume

  - delay: '00:00:10'

  - service: media_player.play_media
    data_template:
      entity_id: media_player.chromecast
      media_content_id: >
        {% if now().strftime("%M")|int == 30 %}
        https://raw.githubusercontent.com/CCOSTAN/Home-AssistantConfig/master/sounds/cuckoo-clock-01.wav
        {% else %}
        https://raw.githubusercontent.com/CCOSTAN/Home-AssistantConfig/master/sounds/cuckoo-clock-{{now().strftime("%I")}}.wav
        {% endif %}
      media_content_type: audio/mp4

  - delay: '00:00:15'

  - service: media_player.turn_off
    entity_id: media_player.chromecast

  - service: media_player.turn_off
    entity_id: media_player.amplificatore_onkyo
